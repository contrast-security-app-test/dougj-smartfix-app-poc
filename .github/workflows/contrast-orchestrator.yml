name: Contrast Shared Orchestrator POC

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      contrast_url:
        required: true
        type: string
        description: The contrast url to connect to
      contrast_org_id:
        required: true
        type: string
        description: The contrast organization id
      contrast_app_id:
        required: true
        type: string
        description: The contrast application id
    secrets:
      CONTRAST_API_KEY:
        required: true
        description: The contrast API key
      CONTRAST_AUTHORIZATION_KEY:
        required: true
        description: The contrast authorization key

jobs:
  run-orchestrator:
    runs-on: ubuntu-latest
    outputs:
      scans: ${{ steps.set-matrix.outputs.scans }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull Contrast Orchestrator Image
        run: docker pull dougjeremias489/contrast-orchestrator

      - name: Run Contrast Orchestrator
        id: orchestrator
        shell: bash
        run: |
          docker run \
            dougjeremias489/contrast-orchestrator \
            --contrast_url "${{ inputs.contrast_url }}" \
            --contrast_org_id "${{ inputs.contrast_org_id }}" \
            --contrast_app_id "${{ inputs.contrast_app_id }}" \
            --api_key "${{ secrets.CONTRAST_API_KEY }}" \
            --authorization_key "${{ secrets.CONTRAST_AUTHORIZATION_KEY }}" > output.txt 2>&1

          cat output.txt

      - name: Parse scans and create matrix
        id: set-matrix
        shell: bash
        run: |
          # Check if output file exists
          if [ ! -f output.txt ]; then
            echo "Error: output.txt not found"
            exit 1
          fi

          # Show what we're working with
          echo "=== Full output.txt contents ==="
          cat output.txt
          echo "=== End of output.txt ==="

          # Extract JSON line from output
          scans=$(grep -o '{"products":\[.*\]}' output.txt || echo "")

          # Check if we found the JSON
          if [ -z "$scans" ]; then
            echo "Error: Could not find JSON products object in output"
            echo "Setting default for testing: {\"products\":[\"smartscan\",\"smartfix\"]}"
            scans='{"products":["smartscan","smartfix"]}'
          fi

          echo "scans=$scans" >> $GITHUB_OUTPUT
          echo "Generated matrix: $scans"

  run-scans:
    needs: run-orchestrator
    runs-on: ubuntu-latest
    strategy:
      matrix:
        scan: ${{ fromJson(needs.run-orchestrator.outputs.scans).products }}
    steps:
      - name: Run ${{ matrix.scan }}
        run: echo "Running ${{ matrix.scan }}"
