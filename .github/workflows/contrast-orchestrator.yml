name: Contrast Shared Orchestrator POC

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      contrast_url:
        required: true
        type: string
        description: The contrast url to connect to
      contrast_org_id:
        required: true
        type: string
        description: The contrast organization id
      contrast_app_id:
        required: true
        type: string
        description: The contrast application id
    secrets:
      CONTRAST_API_KEY:
        required: true
        description: The contrast API key
      CONTRAST_AUTHORIZATION_KEY:
        required: true
        description: The contrast authorization key

jobs:
  run-orchestrator:
    runs-on: ubuntu-latest
    outputs:
      scans: ${{ steps.set-matrix.outputs.scans }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull Contrast Orchestrator Image
        run: docker pull dougjeremias489/contrast-orchestrator

      - name: Run Contrast Orchestrator
        id: orchestrator
        shell: bash
        run: |
          docker run \
            dougjeremias489/contrast-orchestrator \
            --contrast_url "${{ inputs.contrast_url }}" \
            --contrast_org_id "${{ inputs.contrast_org_id }}" \
            --contrast_app_id "${{ inputs.contrast_app_id }}" \
            --api_key "${{ secrets.CONTRAST_API_KEY }}" \
            --authorization_key "${{ secrets.CONTRAST_AUTHORIZATION_KEY }}" > output.txt 2>&1

          cat output.txt

      - name: Parse scans and create matrix
        id: set-matrix
        shell: bash
        run: |
          # Extract scan names between markers
          scans=$(sed -n '/CONTRAST_SCANS_START/,/CONTRAST_SCANS_END/p' output.txt | grep -v "CONTRAST_SCANS")

          # Convert to JSON array format
          json_array="["
          first=true
          while IFS= read -r line; do
            if [ ! -z "$line" ]; then
              if [ "$first" = true ]; then
                json_array+="\"$line\""
                first=false
              else
                json_array+=",\"$line\""
              fi
            fi
          done <<< "$scans"
          json_array+="]"

          echo "scans=$json_array" >> $GITHUB_OUTPUT
          echo "Generated matrix: $json_array"

  run-scans:
    needs: run-orchestrator
    runs-on: ubuntu-latest
    strategy:
      matrix:
        scan: ${{ fromJson(needs.run-orchestrator.outputs.scans) }}
    steps:
      - name: Run ${{ matrix.scan }}
        run: echo "Running ${{ matrix.scan }}"
