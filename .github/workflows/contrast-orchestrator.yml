name: Contrast Shared Orchestrator POC

on:
  #workflow_dispatch:
  workflow_call:
    inputs:
      contrast_host:
        required: true
        type: string
        description: The contrast url to connect to
      contrast_org_id:
        required: true
        type: string
        description: The contrast organization id
      contrast_app_id:
        required: true
        type: string
        description: The contrast application id
      github_app_installation_id:
        required: true
        type: string
        description: The contrast application id
      repo_url:
        required: false
        type: string
        description: The repository url
      repo_name:
        required: false
        type: string
        description: The repository name
      base_branch:
        required: true
        type: string
        description: "The default branch to use"
      build_command:
        description: 'Build command to run before SmartFix'
        required: true
        type: string
      formatting_command:
        description: 'Format command to run before SmartFix'
        required: false
        type: string
      agent_model:
        description: 'The provider LLM model to use'
        required: false
        type: string
      use_contrast_llm:
        required: false
        type: string
        default: 'false'
        description: "Indicates if the PR was merged"
      max_open_prs:
        description: 'Maximum number of open PRs'
        required: false
        type: string
        default: '5'
      aws_region:
        description: 'The AWS region for Bedrock LLM'
        required: false
        type: string
        #default: 'us-east-1'
      azure_api_base:
        description: 'The Azure API base URL'
        required: false
        type: string
      azure_api_version:
        description: 'The Azure API version'
        required: false
        type: string
      enable_full_telemetry:
        description: 'Enable full telemetry for debugging'
        required: false
        type: string
        default: 'true'
      debug_mode:
        description: 'Enable debug mode for verbose logging'
        required: false
        type: string
        default: 'false'
      github_runner:
        description: 'The GitHub runner to use (example: ubuntu-latest)'
        required: false
        type: string
        default: 'ubuntu-latest'
    secrets:
      CONTRAST_API_KEY:
        required: true
        description: The contrast API key
      CONTRAST_AUTHORIZATION_KEY:
        required: true
        description: The contrast authorization key
      GEMINI_API_KEY:
        required: false
        description: The Google Gemini API key
      ANTHROPIC_API_KEY:
        required: false
        description: The Anthropic API key
      AZURE_API_KEY:
        required: false
        description: The Azure API key
      AWS_BEARER_TOKEN_BEDROCK:
        required: false
        description: The AWS Bedrock API key
      AWS_ACCESS_KEY_ID:
        required: false
        description: The AWS access key
      AWS_SECRET_ACCESS_KEY:
        required: false
        description: The AWS access key
      AWS_SESSION_TOKEN:
        required: false
        description: The AWS session token
      GH_TOKEN:
        required: true
        description: The GitHub token

permissions:
  contents: write
  pull-requests: write
  #issues: write
  #actions: read

jobs:
  run-orchestrator:
    name: Run Config Orchestrator
    runs-on: ${{ inputs.github_runner }}
    outputs:
      smart-scan: ${{ steps.set-outputs.outputs.smart-scan }}
      smartfix: ${{ steps.set-outputs.outputs.smartfix }}
      smart-sca: ${{ steps.set-outputs.outputs.smart-sca }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull Contrast Orchestrator Image
        run: docker pull dougjeremias489/contrast-orchestrator

      - name: Run Contrast Orchestrator
        id: orchestrator
        shell: bash
        run: |
          docker run \
            dougjeremias489/contrast-orchestrator \
            --contrast_url "${{ inputs.contrast_host }}" \
            --contrast_org_id "${{ inputs.contrast_org_id }}" \
            --contrast_app_id "${{ inputs.contrast_app_id }}" \
            --api_key "${{ secrets.CONTRAST_API_KEY }}" \
            --authorization_key "${{ secrets.CONTRAST_AUTHORIZATION_KEY }}" 2>&1 | tee output.txt

      - name: Parse product flags and set outputs
        id: set-outputs
        shell: bash
        run: |
          json_output=$(cat output.txt | grep '{"Smart-Scan":' | head -1)
          smart_scan=$(echo "$json_output" | jq -r '."Smart-Scan"')
          smartfix=$(echo "$json_output" | jq -r '.SmartFix')
          smart_sca=$(echo "$json_output" | jq -r '."Smart-SCA"')

          echo "smart-scan=$smart_scan" >> $GITHUB_OUTPUT
          echo "smartfix=$smartfix" >> $GITHUB_OUTPUT
          echo "smart-sca=$smart_sca" >> $GITHUB_OUTPUT

#  get-app-token:
#    name: Get App Token
#    needs: run-orchestrator
#    runs-on: ubuntu-latest
#    outputs:
#      token: ${{ steps.app-token.outputs.token }}
#    steps:
#      - name: Generate GitHub App Token
#        id: app-token
#        uses: actions/create-github-app-token@v2
#        with:
#          app-id: ${{ secrets.SMARTFIX_APP_ID }}
#          private-key: ${{ secrets.SMARTFIX_APP_PRIVATE_KEY }}

  run-smart-scan:
    name: Run SmartScan
    needs: run-orchestrator
    if: ${{ needs.run-orchestrator.outputs.smart-scan == 'true' }}
    runs-on: ${{ inputs.github_runner }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Step Before Smart-SCAN
        run: echo "Hello from some in-between step if needed...."

      - name: Run Smart-SCAN
        uses: docker://dougjeremias489/contrast-smartscan
        env:
          CONTRAST_GITHUB_APP_TS_URL: ${{ inputs.contrast_host }}
          CONTRAST_GITHUB_APP_ORG_ID: ${{ inputs.contrast_org_id }}

  run-sca:
    name: Run Smart SCA
    needs: run-orchestrator
    if: ${{ needs.run-orchestrator.outputs.smart-sca == 'true' }}
    runs-on: ${{ inputs.github_runner }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Smart-SCA
        uses: docker://dougjeremias489/contrast-sca-cli
        env:
          CONTRAST_GITHUB_APP_TS_URL: ${{ inputs.contrast_host }}
          CONTRAST_GITHUB_APP_ORG_ID: ${{ inputs.contrast_org_id }}
          CONTRAST_GITHUB_APP_INSTALLATION_ID: ${{ inputs.github_app_installation_id }}
          CONTRAST_GITHUB_APP_API_KEY: ${{ secrets.CONTRAST_API_KEY }}
          CONTRAST_GITHUB_APP_AUTHORIZATION_KEY: ${{ secrets.CONTRAST_AUTHORIZATION_KEY }}
          GITHUB_SERVER_URL: ${{ inputs.repo_url }}
          GITHUB_REPOSITORY: ${{ inputs.repo_name }}

  run-smartfix:
    name: Run SmartFix
    needs: run-orchestrator
    if: |
      (needs.run-orchestrator.outputs.smartfix == 'true') &&
      (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') ||
      (github.event_name == 'pull_request' && github.event.action ==  'closed')
    runs-on: ${{ inputs.github_runner }}
    steps:
      - name: Determine SmartFix Job Type
        id: determine_job_name
        shell: bash
        run: |
          if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "job_name=Notify Contrast on PR Merge" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.pull_request.merged }}" == "false" ]]; then
            echo "job_name=Handle PR Close" >> $GITHUB_OUTPUT
          else
            echo "job_name=Run Contrast AI SmartFix - Generate Fixes" >> $GITHUB_OUTPUT
          fi

      #- name: Configure AWS Credentials
        #if: ${{ inputs.aws_region != '' }}
        #continue-on-error: true
        #uses: aws-actions/configure-aws-credentials@v5
        #with:
          #aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          #aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          #aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          #aws-region: ${{ inputs.aws_region }}

      - name: Verify AWS Credentials (Debug)
        if: ${{ inputs.aws_region != '' }}
        shell: bash
        run: |
          echo "AWS_REGION is set to: $AWS_REGION"
          echo "AWS_DEFAULT_REGION is set to: $AWS_DEFAULT_REGION"
          echo "AWS_ACCESS_KEY_ID is set: $([ -n "$AWS_ACCESS_KEY_ID" ] && echo 'YES' || echo 'NO')"
          echo "AWS_SECRET_ACCESS_KEY is set: $([ -n "$AWS_SECRET_ACCESS_KEY" ] && echo 'YES' || echo 'NO')"
          echo "AWS_SESSION_TOKEN is set: $([ -n "$AWS_SESSION_TOKEN" ] && echo 'YES' || echo 'NO')"
          aws sts get-caller-identity || echo "AWS credentials test failed"

      - name: ${{ steps.determine_job_name.outputs.job_name }}
        uses: Contrast-Security-OSS/contrast-ai-smartfix-action@AIML-313-simplify-smartfix-yml-job
        with:
          base_branch: ${{ inputs.base_branch }}
          build_command: ${{ inputs.build_command }}
          formatting_command: ${{ inputs.formatting_command }}
          use_contrast_llm: ${{ inputs.use_contrast_llm }}
          max_open_prs: ${{ inputs.max_open_prs }}
          aws_region: ${{ inputs.aws_region }}
          agent_model: ${{ inputs.agent_model }}
          azure_api_base: ${{ inputs.azure_api_base }}
          azure_api_version: ${{ inputs.azure_api_version }}
          enable_full_telemetry: ${{ inputs.enable_full_telemetry }}
          debug_mode: ${{ inputs.debug_mode }}
          contrast_host: ${{ inputs.contrast_host }}
          contrast_org_id: ${{ inputs.contrast_org_id }}
          contrast_app_id: ${{ inputs.contrast_app_id }}
          contrast_authorization_key: ${{ secrets.CONTRAST_AUTHORIZATION_KEY }}
          contrast_api_key: ${{ secrets.CONTRAST_API_KEY }}
          github_token: ${{ secrets.GH_TOKEN }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          azure_api_key: ${{ secrets.AZURE_API_KEY }}
          aws_bearer_token_bedrock: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
