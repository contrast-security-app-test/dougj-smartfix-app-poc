name: SmartFix
on:
  workflow_call:
    inputs:
      contrast_url:
        required: true
        type: string
        description: The contrast url to connect to
      contrast_org_id:
        required: true
        type: string
        description: The contrast organization id
      contrast_app_id:
        required: true
        type: string
        description: The contrast application id
      event_name:
        required: true
        type: string
        description: "The name of the github event that triggered the caller."
      event_path:
        required: true
        type: string
        description: "The path of the github event that triggered the caller."
      event_action:
        required: true
        type: string
        description: "The action of the github event that triggered the caller."
      git_head_ref:
        required: true
        type: string
        description: "The git head ref that triggered the workflow."
      base_branch:
        required: true
        type: string
        description: The base branch for PRs
      build_command:
        description: 'Build command to run before SmartFix'
        required: true
        type: string
      formatting_command:
        description: 'Format command to run before SmartFix'
        required: false
        type: string
      agent_model:
        description: 'The provider LLM model to use'
        required: false
        type: string
        default: 'bedrock/us.anthropic.claude-sonnet-4-5-20250929-v1:0'
      pr_was_merged:
        required: false
        type: boolean
        description: "Indicates if the PR was merged"
      use_contrast_llm:
        required: false
        type: string
        default: 'false'
        description: "Indicates if the PR was merged"
      max_open_prs:
        description: 'Maximum number of open PRs'
        required: false
        type: string
        default: '5'
      aws_region:
        description: 'The AWS region for Bedrock LLM'
        required: false
        type: string
        default: 'us-east-1'
      azure_api_base:
        description: 'The Azure API base URL'
        required: false
        type: string
      azure_api_version:
        description: 'The Azure API version'
        required: false
        type: string
      enable_full_telemetry:
        description: 'Enable full telemetry for debugging'
        required: false
        type: string
        default: 'true'
      debug_mode:
        description: 'Enable debug mode for verbose logging'
        required: false
        type: string
        default: 'false'
    secrets:
      CONTRAST_API_KEY:
        required: true
        description: The contrast API key
      CONTRAST_AUTHORIZATION_KEY:
        required: true
        description: The contrast authorization key
      GEMINI_API_KEY:
        required: false
        description: The Google Gemini API key
      ANTHROPIC_API_KEY:
        required: false
        description: The Anthropic API key
      AZURE_API_KEY:
        required: false
        description: The Azure API key
      AWS_BEARER_TOKEN_BEDROCK:
        required: false
        description: The AWS Bedrock API key

permissions:
  contents: write
  pull-requests: write
  #issues: write # required to create issues
  #actions: read # Required for SmartFix to find claude workflow run

jobs:
  show_inputs:
    name: Show Inputs
    runs-on: ubuntu-latest
    steps:
      - name: Display Inputs
        run: |
          echo "Contrast URL: ${{ inputs.contrast_url }}"
          echo "Contrast Org ID: ${{ inputs.contrast_org_id }}"
          echo "Contrast App ID: ${{ inputs.contrast_app_id }}"
          echo "Event Name: ${{ inputs.event_name }}"
          echo "Event Path: ${{ inputs.event_path }}"
          echo "Event Action: ${{ inputs.event_action }}"
          echo "Git Head Ref: ${{ inputs.git_head_ref }}"
          echo "Base Branch: ${{ inputs.base_branch }}"
          echo "PR Was Merged: ${{ inputs.pr_was_merged }}"
          echo "build_command: ${{ inputs.build_command }}"
          echo "use_contrast_llm: ${{ inputs.use_contrast_llm }}"
          echo "max_open_prs: ${{ inputs.max_open_prs }}"
          echo "enable_full_telemetry: ${{ inputs.enable_full_telemetry }}"
  run_smartfix:
    name: SmartFix
    if: |
      (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') ||
      (github.event_name == 'pull_request' && github.event.action ==  'closed')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine SmartFix Job Type
        id: determine_job_name
        shell: bash
        run: |
          if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "job_name=Notify Contrast on PR Merge" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.pull_request.merged }}" == "false" ]]; then
            echo "job_name=Handle PR Close" >> $GITHUB_OUTPUT
          else
            echo "job_name=Run Contrast AI SmartFix - Generate Fixes" >> $GITHUB_OUTPUT
          fi
      - name: ${{ steps.determine_job_name.outputs.job_name }}
        uses: Contrast-Security-OSS/contrast-ai-smartfix-action@AIML-313-simplify-smartfix-yml-job
        with:
          use_contrast_llm: ${{ inputs.use_contrast_llm }}
          max_open_prs: ${{ inputs.max_open_prs }}
          base_branch: '${{ inputs.base_branch }}'
          build_command: '${{ inputs.build_command }}'
          formatting_command: '${{ inputs.formatting_command }}'
          max_qa_attempts: 5
          github_token: ${{ secrets.GITHUB_TOKEN }}
          contrast_host: ${{ inputs.contrast_url }}
          contrast_org_id: ${{ inputs.contrast_org_id }}
          contrast_app_id: ${{ inputs.contrast_app_id }}
          contrast_api_key: ${{ secrets.CONTRAST_API_KEY }}
          contrast_authorization_key: ${{ secrets.CONTRAST_AUTHORIZATION_KEY }}

          # LLM Provider Configuration (Required if not using Contrast LLM) ---
          agent_model: ${{ inputs.agent_model }}

          # --- Google Gemini API Credentials ---
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

          # --- Anthropic API Credentials ---
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # --- AWS Bedrock API Key (Alternative to IAM credentials, less secure) ---
          aws_bearer_token_bedrock: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
          aws_region: ${{ inputs.aws_region }}

          # --- Azure Open API Credentials ---
          azure_api_key: ${{ secrets.AZURE_API_KEY }}
          azure_api_base: ${{ inputs.azure_api_base }}
          azure_api_version: ${{ inputs.azure_api_version }}

          # Other Optional Inputs (see action.yml for defaults and more options)
          enable_full_telemetry: ${{ inputs.enable_full_telemetry }}
          debug_mode: ${{ inputs.debug_mode }}
